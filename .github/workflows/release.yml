name: Release Workflow

on:
  release:
    types: [published]

jobs:
  update-changelog:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v3
        with:
          ref: ${{ github.event.release.target_commitish }}
          fetch-depth: 0
          persist-credentials: true

      - name: Append release notes to changelog
        run: |
          TAG_NAME="${{ github.event.release.tag_name }}"
          RELEASE_BODY="${{ github.event.release.body }}"
          CHANGELOG_FILE="docs/changelog.md"
      
          # Ensure changelog exists with at least a heading
          if [ ! -f "$CHANGELOG_FILE" ]; then
            echo "# Changelog" > "$CHANGELOG_FILE"
          fi
      
          if [ -z "$RELEASE_BODY" ]; then
            RELEASE_BODY="No release notes provided."
          fi
      
          # Split the heading and the rest of the changelog
          HEADING=$(head -n 1 "$CHANGELOG_FILE")
          REST=$(tail -n +2 "$CHANGELOG_FILE")
      
          # Prepend release notes after heading
          {
            echo "$HEADING"
            echo "\n"
            printf '## %s\n\n%s\n\n' "$TAG_NAME" "$RELEASE_BODY"
            echo "$REST"
          } > "$CHANGELOG_FILE"

      - name: Commit and push updated changelog
        run: |
          git config --global user.name github-actions
          git config --global user.email github-actions@github.com
          git remote set-url origin https://${{ secrets.RELEASE_WORKFLOW }}@github.com/bitstep-ie/mango-go.git
          git add docs/changelog.md
          # only commit if there are changes
          if ! git diff --cached --quiet; then
            git commit -m "Update changelog for ${{ github.event.release.tag_name }}"
            git push --set-upstream origin ${{ github.event.release.target_commitish }}
          else
            echo "No changelog changes to commit."
          fi
        env:
          PERSONAL_ACCESS_TOKEN: ${{ secrets.RELEASE_WORKFLOW }}

      - name: Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: 'latest'

      - name: Build Hugo site
        run: hugo --source docs --destination public --minify

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4.0.0
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public